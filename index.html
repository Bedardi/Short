<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MistaHub Short URL Service by Bedardi Bhai - Create and track short URLs with ease. Fast, reliable, and free.">
    <meta name="keywords" content="URL shortener, MistaHub, Bedardi Bhai, short URL, link tracking, free URL shortener">
    <meta name="author" content="MistaHub">
    <meta name="robots" content="index, follow">
    <!-- Open Graph for Social Media -->
    <meta property="og:title" content="MistaHub Short URL Service by Bedardi Bhai">
    <meta property="og:description" content="Shorten and track URLs with MistaHub's free service, powered by Bedardi Bhai.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bhai.pages.dev">
    <meta property="og:image" content="https://bhai.pages.dev/og-image.jpg">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MistaHub Short URL Service by Bedardi Bhai">
    <meta name="twitter:description" content="Shorten and track URLs with MistaHub. Fast and free, by Bedardi Bhai.">
    <meta name="twitter:image" content="https://bhai.pages.dev/og-image.jpg">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    <title>MistaHub Short URL Service by Bedardi Bhai</title>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900 transition-colors duration-300">
    <header class="bg-indigo-600 text-white text-center py-8">
        <h1 class="text-5xl font-extrabold tracking-tight animate-pulse">MistaHub</h1>
        <p class="mt-2 text-xl font-medium">Short URL Service Powered by <span class="font-bold text-green-300">Bedardi Bhai</span></p>
        <button id="themeToggle" class="mt-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
        </button>
    </header>
    
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Shorten URL Section -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 transition-all duration-300">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Shorten Your URL</h2>
            <div class="mb-4">
                <label for="longUrl" class="block text-gray-700 dark:text-gray-300 mb-2">Enter Long URL</label>
                <input id="longUrl" type="url" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="https://example.com/very/long">
            </div>
            <div class="mb-4">
                <label for="expiration" class="block text-gray-700 dark:text-gray-300 mb-2">URL Validity</label>
                <select id="expiration" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <option value="unlimited" selected>Unlimited</option>
                    <option value="1hour">1 Hour</option>
                    <option value="12hour">12 Hours</option>
                    <option value="1day">1 Day</option>
                    <option value="3day">3 Days</option>
                    <option value="15day">15 Days</option>
                    <option value="1month">1 Month</option>
                    <option value="3month">3 Months</option>
                    <option value="6month">6 Months</option>
                    <option value="1year">1 Year</option>
                </select>
            </div>
            <label class="flex items-center mb-4">
                <input type="checkbox" id="enableTracking" checked class="mr-2">
                <span class="text-gray-700 dark:text-gray-300">Enable Tracking (Clicks, IP, etc.)</span>
            </label>
            <button onclick="shortenUrl()" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-300">Shorten Now</button>
            <div id="result" class="mt-4"></div>
        </div>
        
        <!-- Analytics Section -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transition-all duration-300">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Track Your Short URL</h2>
            <div class="mb-4">
                <label for="shortCode" class="block text-gray-700 dark:text-gray-300 mb-2">Enter Short Code</label>
                <input id="shortCode" type="text" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="abc123">
            </div>
            <button onclick="getAnalytics()" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-300">View Analytics</button>
            <div id="analytics-result" class="mt-4"></div>
        </div>
    </div>
    
    <footer class="text-center py-4 text-gray-600 dark:text-gray-400">Â© 2025 MistaHub | Powered by <span class="font-bold text-indigo-600 dark:text-indigo-400">Bedardi Bhai</span></footer>

    <!-- Firebase SDK and Custom JS (Combined in Module with Enhanced Debug) -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getDatabase, ref, set, update, onValue } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // Fetch Firebase config from secret environment variables
        const firebaseConfig = {
            apiKey: import.meta.env.FIREBASE_API_KEY || 'MISSING_API_KEY',
            authDomain: import.meta.env.FIREBASE_AUTH_DOMAIN || 'MISSING_AUTH_DOMAIN',
            databaseURL: import.meta.env.FIREBASE_DATABASE_URL || 'MISSING_DATABASE_URL',
            projectId: import.meta.env.FIREBASE_PROJECT_ID || 'MISSING_PROJECT_ID',
            storageBucket: import.meta.env.FIREBASE_STORAGE_BUCKET || 'MISSING_STORAGE_BUCKET',
            messagingSenderId: import.meta.env.FIREBASE_MESSAGING_SENDER_ID || 'MISSING_MESSAGING_SENDER_ID',
            appId: import.meta.env.FIREBASE_APP_ID || 'MISSING_APP_ID'
        };

        // Debug: Log config to verify secrets
        console.log('Firebase Config:', firebaseConfig);

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            console.log('Firebase App Initialized:', app);
            const db = getDatabase(app);
            console.log('Database Initialized:', db);
        } catch (error) {
            console.error('Firebase Initialization Error:', error);
        }

        const DOMAIN = 'https://bhai.pages.dev';

        // Theme Toggle
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
            });
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }
        });

        // Shorten URL
        window.shortenUrl = async function() {
            const longUrl = document.getElementById('longUrl').value.trim();
            const expiration = document.getElementById('expiration').value;
            const enableTracking = document.getElementById('enableTracking').checked;
            if (!longUrl) {
                alert('Please enter a valid URL');
                return;
            }
            if (!longUrl.match(/^https?:\/\/.+/)) {
                alert('URL must start with http:// or https://');
                return;
            }
            try {
                const urlsRef = ref(db, 'urls');
                let shortCode;
                let exists;
                do {
                    shortCode = Math.random().toString(36).substring(2, 8);
                    exists = await new Promise((resolve) => onValue(ref(db, `urls/${shortCode}`), (snapshot) => resolve(snapshot.exists())));
                } while (exists);
                let expiry = null;
                if (expiration !== 'unlimited') {
                    let ms = 0;
                    const num = parseInt(expiration);
                    if (expiration.endsWith('hour')) ms = num * 3600000;
                    else if (expiration.endsWith('day')) ms = num * 86400000;
                    else if (expiration.endsWith('month')) ms = num * 2592000000;
                    else if (expiration.endsWith('year')) ms = num * 31536000000;
                    expiry = Date.now() + ms;
                }
                const data = {
                    longUrl,
                    clicks: [],
                    expiry,
                    trackEnabled: enableTracking
                };
                await set(ref(db, `urls/${shortCode}`), data);
                const shortUrl = `${DOMAIN}/${shortCode}`;
                document.getElementById('result').innerHTML = `
                    <p class="text-green-600 dark:text-green-400">
                        Short URL: <a href="${shortUrl}" target="_blank" rel="noopener">${shortUrl}</a>
                        <button class="copy-btn bg-indigo-600 text-white px-3 py-1 rounded-lg ml-2 hover:bg-indigo-700 transition duration-300" onclick="copyToClipboard('${shortUrl}', this)">
                            Copy
                        </button>
                    </p>
                `;
                alert('URL shortened successfully!');
            } catch (error) {
                console.error('Shorten Error:', error); // Debug log
                alert('Failed to shorten URL: ' + error.message);
            }
        };

        // Get Analytics
        window.getAnalytics = async function() {
            const shortCode = document.getElementById('shortCode').value.trim();
            if (!shortCode) {
                alert('Please enter a short code');
                return;
            }
            try {
                const snapshot = await new Promise((resolve) => onValue(ref(db, `urls/${shortCode}`), (snap) => resolve(snap)));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const uniqueIPs = new Set(data.clicks ? data.clicks.map(c => c.ip) : []);
                    document.getElementById('analytics-result').innerHTML = `
                        <ul class="text-gray-800 dark:text-gray-200">
                            <li><strong>Long URL:</strong> <a href="${data.longUrl}" target="_blank" rel="noopener">${data.longUrl}</a></li>
                            <li><strong>Expiry:</strong> ${data.expiry ? new Date(data.expiry).toLocaleString() : 'Unlimited'}</li>
                            <li><strong>Tracking Enabled:</strong> ${data.trackEnabled ? 'Yes' : 'No'}</li>
                            <li><strong>Total Clicks:</strong> ${data.clicks ? data.clicks.length : 0}</li>
                            <li><strong>Unique IPs:</strong> ${uniqueIPs.size}</li>
                            <li><strong>Click Details:</strong>
                                <ul class="ml-4">
                                    ${data.clicks ? data.clicks.map(click => `<li>IP: ${click.ip} | Time: ${new Date(click.timestamp).toLocaleString()}</li>`).join('') : '<li>No clicks yet</li>'}
                                </ul>
                            </li>
                        </ul>
                    `;
                    alert('Analytics fetched successfully!');
                } else {
                    alert('Short code not found');
                }
            } catch (error) {
                console.error('Analytics Error:', error); // Debug log
                alert('Failed to fetch analytics: ' + error.message);
            }
        };

        // Copy to Clipboard
        window.copyToClipboard = function(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                button.classList.add('copied');
                setTimeout(() => button.classList.remove('copied'), 2000);
                alert('Short URL copied to clipboard!');
            }).catch(err => {
                console.error('Copy Error:', err); // Debug log
                alert('Failed to copy URL: ' + err.message);
            });
        };

        // Handle Redirects
        window.onload = async function() {
            const path = window.location.pathname;
            if (path !== '/' && path !== '/index.html') {
                const shortCode = path.slice(1);
                try {
                    const snapshot = await new Promise((resolve) => onValue(ref(db, `urls/${shortCode}`), (snap) => resolve(snap)));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (data.expiry && Date.now() > data.expiry) {
                            document.body.innerHTML = '<h1 class="text-center text-2xl font-bold text-gray-800 dark:text-gray-200 mt-8">URL Expired</h1><p class="text-center text-gray-600 dark:text-gray-400">This short URL has expired.</p>';
                            return;
                        }
                        if (data.trackEnabled) {
                            let ip = 'Unknown';
                            try {
                                const res = await fetch('https://api.ipify.org?format=json');
                                const json = await res.json();
                                ip = json.ip;
                            } catch (e) {}
                            const timestamp = new Date().toISOString();
                            const clicks = data.clicks || [];
                            clicks.push({ ip, timestamp });
                            await update(ref(db, `urls/${shortCode}`), { clicks });
                        }
                        window.location.href = data.longUrl;
                    } else {
                        document.body.innerHTML = '<h1 class="text-center text-2xl font-bold text-gray-800 dark:text-gray-200 mt-8">URL Not Found</h1><p class="text-center text-gray-600 dark:text-gray-400">Sorry, the requested URL does not exist.</p>';
                    }
                } catch (error) {
                    console.error('Redirect Error:', error); // Debug log
                    document.body.innerHTML = `<h1 class="text-center text-2xl font-bold text-gray-800 dark:text-gray-200 mt-8">Error</h1><p class="text-center text-gray-600 dark:text-gray-400">An error occurred: ${error.message}</p>`;
                }
            }
        };
    </script>
    <!-- Schema.org Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "MistaHub Short URL Service by Bedardi Bhai",
        "url": "https://bhai.pages.dev",
        "description": "Shorten and track URLs with MistaHub's free URL shortener, powered by Bedardi Bhai.",
        "publisher": {
            "@type": "Organization",
            "name": "MistaHub",
            "founder": "Bedardi Bhai"
        }
    }
    </script>
</body>
</html>
